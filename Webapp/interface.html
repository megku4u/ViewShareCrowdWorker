<!DOCTYPE html>
<html>
	<head>
		<title>View Share</title>
	</head>
	<div id='buttons'></div>
	<body>
		<p>This is where you can interact with the images</p>
		<h3 id='objectToFind'></h3>
	</body>
	<div id='images'></div>
	<!-- This initializes the firebase app -->
	<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>
	<script>
		var config = {
		apiKey: "AIzaSyBakHl5BORexlsuMT2jUxi5PgQOnuKSco8",
		authDomain: "object-locator.firebaseapp.com",
		databaseURL: "https://object-locator.firebaseio.com",
		projectId: "object-locator",
		storageBucket: "object-locator.appspot.com",
		messagingSenderId: "876037163064"
		};
	</script>

	<!-- These scripts make the different firebase functions available for use -->
	<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-messaging.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-storage.js"></script>
	<script src="uuidGenerator.js"></script> <!-- This is used to generate a UUID -->
	<script scr='notifications.js'></script> <!-- This is to ensure that the user can get assigned to a job and receive notifications -->

	<script type="text/javascript">
		var app = firebase.initializeApp(config);
		var database = app.database();
		var storage = app.storage();
		var imagesRef = storage.ref()

		firebase.auth().onAuthStateChanged(function(user) {
			if (user) {
				uid = user.uid; // gets unique user id

				var tokenRef = database.ref('notification_tokens/' + uid + '/assignments'); // creates reference to the user's jobs
				tokenRef.once('value').then(function(snapshot){
					if (snapshot.val()) { //check if there are any assignments to look at

						jobs = Object.keys(snapshot.val());
						for (i = 0; i < jobs.length; i++) {
							jobID = jobs[i];
							var object = snapshot.child(jobID).child('object_to_find').val();
							console.log(object);
							var button = document.createElement('button');
							//button.setAttribute('content', object);
							button.setAttribute('class', 'option');
							button.setAttribute('jobID', jobID)
							button.innerHTML = object;

							button.addEventListener('click', function() {
								console.log('HIT THE BUTTON');
								displayJob(this);
							});
							document.getElementById('buttons').appendChild(button);

						}
					}
					else { //if no assignments, show the user that
						document.getElementById('objectToFind').innerHTML = 'No images to show';
					}


				})

			// User is signed in.
			} else {
			// No user is signed in.
				return null;
			}
		});


		function displayJob(element) {
			document.getElementById('images').innerHTML = ''; //clear all the images from previously shown assignment

			jobID = element.getAttribute('jobID');
			objectToFind = element.innerHTML;
			document.getElementById('objectToFind').innerHTML = 'Find ' + objectToFind;

			var jobRef = database.ref('labeling_jobs/' + jobID + '/additional_images');
			jobRef.on('child_added', function(childSnapshot, prevChildKey) {
				var imageID = childSnapshot.key;
				var image = imagesRef.child(imageID + '.jpg');
				image.getDownloadURL().then(function(url) {
					var img = document.createElement('img');
					img.src = url;
					img.id = 'cross';
					img.setAttribute('image-UUID', imageID);
					img.addEventListener('click', function() {
						cursorClick(event, this, jobID, uid);
					});
					document.getElementById('images').appendChild(img);
				})
			});
		}


		function cursorClick(event, element, jobID, uid) {
			var pos_x = event.offsetX?(event.offsetX):event.pageX-document.getElementById("pointer_div").offsetLeft;
			var pos_y = event.offsetY?(event.offsetY):event.pageY-document.getElementById("pointer_div").offsetTop;
			document.getElementById("cross").style.left = (pos_x-1) ;
			document.getElementById("cross").style.top = (pos_y-15) ;
			document.getElementById("cross").style.visibility = "visible" ;
			var imageUUID = element.getAttribute('image-UUID');
			sendResponse(pos_x, pos_y, jobID, uid, imageUUID);

				// THIS PRINTS OUT THE PIXEL LOCATION OF CLICKS ON THE PAGE
			// var para = document.createElement('p');
			// var node = document.createTextNode('x: ' + pos_x + 'y: ' + pos_y + '\n')
			// para.appendChild(node);
			// document.body.appendChild(node);
		}

		function sendResponse(pos_x, pos_y, jobID, uid, imageUUID) {
			var requestingRef = database.ref('labeling_jobs/' + jobID + '/requesting_user');
			requestingRef.once('value').then(function(snapshot) {
				var requestingUser = snapshot.val();
				var responseRef = database.ref('responses/' + requestingUser + '/' + jobID);
				responseRef.child(uid + '_' + uuidv1()).set({
					imageUUID: imageUUID,
					x: pos_x,
					y: pos_y

				});
				console.log(requestingUser);

			});
		}

		initApp = function() {
			firebase.auth().onAuthStateChanged(function(user) {
			  if (user) {
			    // User is signed in.
			    uid = user.uid;
			    user.getIdToken().then(function(accessToken) {
					//console.log(uid)
			      //}, null, '  ');
				});
			  } else {
			    // User is signed out.
				console.log('User not signed in');
			  }
			}, function(error) {
			  console.log(error);
			});
		};
		window.addEventListener('load', function() {
			initApp()
		});

		function getUID() {
			firebase.auth().onAuthStateChanged(function(user) {
				if (user) {
					uid = user.uid
					console.log(uid)
					return uid;
				// User is signed in.
				} else {
				// No user is signed in.
					return null;
				}
			});
		}
		function getJobRef(userID, database) {
			tokenRef = database.ref('notification_tokens/' + userID + '/assignments')
			return tokenRef;
		}

    </script>





<!-- THIS IS DISPLAYING AN IMAGE FROM THE STORAGE GIVEN ITS FILENAME-->
	<!--<script>
		console.log("test2")
		//var app = firebase.initializeApp(config);

		console.log(uid);

		// You can retrieve services via the defaultApp variable...
		var storage = app.storage();
		var imagesRef = storage.ref();
		var image = imagesRef.child('1699041B-14DC-4C3F-BC73-1A570D205060.jpg');
		image.getDownloadURL().then(function(url) {
			var img = document.createElement('img');
			img.src = url;
			document.body.appendChild(img);
		})
			// }).catch(function(error) {
			//   // Handle any errors
			// });

		//	console.log(img);


		var database = app.database();


		var jobRef = database.ref('/labeling_jobs');
		console.log(5+5);

	</script>-->
</html>
